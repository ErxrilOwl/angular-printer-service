"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
// tslint:disable
// TODO: cleanup this file, it's copied as is from Angular CLI.
const core_1 = require("@angular-devkit/core");
const crypto = require("crypto");
const fs = require("fs");
const semver = require("semver");
const require_project_module_1 = require("../require-project-module");
const operators_1 = require("rxjs/operators");
const rxjs_1 = require("rxjs");
exports.NEW_SW_VERSION = '5.0.0-rc.0';
class CliFilesystem {
    constructor(_host, base) {
        this._host = _host;
        this.base = base;
    }
    list(path) {
        const recursiveList = (path) => this._host.list(path).pipe(
        // Emit each fragment individually.
        operators_1.concatMap(fragments => rxjs_1.from(fragments)), 
        // Join the path with fragment.
        operators_1.map(fragment => core_1.join(path, fragment)), 
        // Emit directory content paths instead of the directory path.
        operators_1.mergeMap(path => this._host.isDirectory(path).pipe(operators_1.concatMap(isDir => isDir ? recursiveList(path) : rxjs_1.of(path)))));
        return recursiveList(this._resolve(path)).pipe(operators_1.map(path => path.replace(this.base, '')), operators_1.toArray()).toPromise().then(x => x, _err => []);
    }
    read(path) {
        return this._readIntoBuffer(path)
            .then(content => core_1.virtualFs.fileBufferToString(content));
    }
    hash(path) {
        const sha1 = crypto.createHash('sha1');
        return this._readIntoBuffer(path)
            .then(content => sha1.update(Buffer.from(content)))
            .then(() => sha1.digest('hex'));
    }
    write(path, content) {
        return this._host.write(this._resolve(path), core_1.virtualFs.stringToFileBuffer(content))
            .toPromise();
    }
    _readIntoBuffer(path) {
        return this._host.read(this._resolve(path))
            .toPromise();
    }
    _resolve(path) {
        return core_1.join(core_1.normalize(this.base), path);
    }
}
function usesServiceWorker(projectRoot) {
    let swPackageJsonPath;
    try {
        swPackageJsonPath = require_project_module_1.resolveProjectModule(projectRoot, '@angular/service-worker/package.json');
    }
    catch (_) {
        // @angular/service-worker is not installed
        throw new Error(core_1.tags.stripIndent `
    Your project is configured with serviceWorker = true, but @angular/service-worker
    is not installed. Run \`npm install --save-dev @angular/service-worker\`
    and try again, or run \`ng set apps.0.serviceWorker=false\` in your .angular-cli.json.
  `);
    }
    const swPackageJson = fs.readFileSync(swPackageJsonPath).toString();
    const swVersion = JSON.parse(swPackageJson)['version'];
    if (!semver.gte(swVersion, exports.NEW_SW_VERSION)) {
        throw new Error(core_1.tags.stripIndent `
    The installed version of @angular/service-worker is ${swVersion}. This version of the CLI
    requires the @angular/service-worker version to satisfy ${exports.NEW_SW_VERSION}. Please upgrade
    your service worker version.
  `);
    }
    return true;
}
exports.usesServiceWorker = usesServiceWorker;
function augmentAppWithServiceWorker(host, projectRoot, appRoot, outputPath, baseHref, ngswConfigPath) {
    // Path to the worker script itself.
    const distPath = core_1.normalize(outputPath);
    const workerPath = core_1.normalize(require_project_module_1.resolveProjectModule(core_1.getSystemPath(projectRoot), '@angular/service-worker/ngsw-worker.js'));
    const swConfigPath = require_project_module_1.resolveProjectModule(core_1.getSystemPath(projectRoot), '@angular/service-worker/config');
    const safetyPath = core_1.join(core_1.dirname(workerPath), 'safety-worker.js');
    const configPath = ngswConfigPath || core_1.join(appRoot, 'ngsw-config.json');
    return host.exists(configPath).pipe(operators_1.switchMap(exists => {
        if (!exists) {
            throw new Error(core_1.tags.oneLine `
          Error: Expected to find an ngsw-config.json configuration
          file in the ${appRoot} folder. Either provide one or disable Service Worker
          in your angular.json configuration file.`);
        }
        return host.read(configPath);
    }), operators_1.map(content => JSON.parse(core_1.virtualFs.fileBufferToString(content))), operators_1.switchMap(configJson => {
        const Generator = require(swConfigPath).Generator;
        const gen = new Generator(new CliFilesystem(host, outputPath), baseHref);
        return gen.process(configJson);
    }), operators_1.switchMap(output => {
        const manifest = JSON.stringify(output, null, 2);
        return host.read(workerPath).pipe(operators_1.switchMap(workerCode => {
            return rxjs_1.merge(host.write(core_1.join(distPath, 'ngsw.json'), core_1.virtualFs.stringToFileBuffer(manifest)), host.write(core_1.join(distPath, 'ngsw-worker.js'), workerCode));
        }));
    }), operators_1.switchMap(() => host.exists(safetyPath)), 
    // If @angular/service-worker has the safety script, copy it into two locations.
    operators_1.switchMap(exists => {
        if (!exists) {
            return rxjs_1.of(undefined);
        }
        return host.read(safetyPath).pipe(operators_1.switchMap(safetyCode => {
            return rxjs_1.merge(host.write(core_1.join(distPath, 'worker-basic.min.js'), safetyCode), host.write(core_1.join(distPath, 'safety-worker.js'), safetyCode));
        }));
    }), 
    // Remove all elements, reduce them to a single emit.
    operators_1.reduce(() => { })).toPromise();
}
exports.augmentAppWithServiceWorker = augmentAppWithServiceWorker;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi8iLCJzb3VyY2VzIjpbInBhY2thZ2VzL2FuZ3VsYXJfZGV2a2l0L2J1aWxkX2FuZ3VsYXIvc3JjL2FuZ3VsYXItY2xpLWZpbGVzL3V0aWxpdGllcy9zZXJ2aWNlLXdvcmtlci9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBOzs7Ozs7R0FNRztBQUNILGlCQUFpQjtBQUNqQiwrREFBK0Q7QUFDL0QsK0NBQWdIO0FBRWhILGlDQUFpQztBQUNqQyx5QkFBeUI7QUFDekIsaUNBQWlDO0FBRWpDLHNFQUFpRTtBQUNqRSw4Q0FBMkY7QUFDM0YsK0JBQW1EO0FBR3RDLFFBQUEsY0FBYyxHQUFHLFlBQVksQ0FBQztBQUczQztJQUNFLFlBQW9CLEtBQXFCLEVBQVUsSUFBWTtRQUEzQyxVQUFLLEdBQUwsS0FBSyxDQUFnQjtRQUFVLFNBQUksR0FBSixJQUFJLENBQVE7SUFBSSxDQUFDO0lBRXBFLElBQUksQ0FBQyxJQUFZO1FBQ2YsTUFBTSxhQUFhLEdBQUcsQ0FBQyxJQUFVLEVBQW9CLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJO1FBQ2hGLG1DQUFtQztRQUNuQyxxQkFBUyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsV0FBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3ZDLCtCQUErQjtRQUMvQixlQUFHLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxXQUFJLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3JDLDhEQUE4RDtRQUM5RCxvQkFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUM5QyxxQkFBUyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FB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QUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FDL0IscUJBQVMsQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUNyQixNQUFNLENBQUMsWUFBSyxDQUNWLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBSSxDQUFDLFFBQVEsRUFBRSxxQkFBcUIsQ0FBQyxFQUFFLFVBQVUsQ0FBQyxFQUM3RCxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQUksQ0FBQyxRQUFRLEVBQUUsa0JBQWtCLENBQUMsRUFBRSxVQUFVLENBQUMsQ0FDdkMsQ0FBQztRQUN4QixDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQyxDQUFDO0lBRUYscURBQXFEO0lBQ3JELGtCQUFNLENBQUMsR0FBRyxFQUFFLEdBQUUsQ0FBQyxDQUFDLENBQ2pCLENBQUMsU0FBUyxFQUFFLENBQUM7QUFDaEIsQ0FBQztBQXhFRCxrRUF3RUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG4vLyB0c2xpbnQ6ZGlzYWJsZVxuLy8gVE9ETzogY2xlYW51cCB0aGlzIGZpbGUsIGl0J3MgY29waWVkIGFzIGlzIGZyb20gQW5ndWxhciBDTEkuXG5pbXBvcnQgeyBQYXRoLCBqb2luLCBub3JtYWxpemUsIHZpcnR1YWxGcywgZGlybmFtZSwgZ2V0U3lzdGVtUGF0aCwgdGFncywgZnJhZ21lbnQgfSBmcm9tICdAYW5ndWxhci1kZXZraXQvY29yZSc7XG5pbXBvcnQgeyBGaWxlc3lzdGVtIH0gZnJvbSAnQGFuZ3VsYXIvc2VydmljZS13b3JrZXIvY29uZmlnJztcbmltcG9ydCAqIGFzIGNyeXB0byBmcm9tICdjcnlwdG8nO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgc2VtdmVyIGZyb20gJ3NlbXZlcic7XG5cbmltcG9ydCB7IHJlc29sdmVQcm9qZWN0TW9kdWxlIH0gZnJvbSAnLi4vcmVxdWlyZS1wcm9qZWN0LW1vZHVsZSc7XG5pbXBvcnQgeyBtYXAsIHJlZHVjZSwgc3dpdGNoTWFwLCBjb25jYXRNYXAsIG1lcmdlTWFwLCB0b0FycmF5LCB0YXAgfSBmcm9tIFwicnhqcy9vcGVyYXRvcnNcIjtcbmltcG9ydCB7IE9ic2VydmFibGUsIG1lcmdlLCBvZiwgZnJvbSB9IGZyb20gXCJyeGpzXCI7XG5cblxuZXhwb3J0IGNvbnN0IE5FV19TV19WRVJTSU9OID0gJzUuMC4wLXJjLjAnO1xuXG5cbmNsYXNzIENsaUZpbGVzeXN0ZW0gaW1wbGVtZW50cyBGaWxlc3lzdGVtIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBfaG9zdDogdmlydHVhbEZzLkhvc3QsIHByaXZhdGUgYmFzZTogc3RyaW5nKSB7IH1cblxuICBsaXN0KHBhdGg6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBjb25zdCByZWN1cnNpdmVMaXN0ID0gKHBhdGg6IFBhdGgpOiBPYnNlcnZhYmxlPFBhdGg+ID0+IHRoaXMuX2hvc3QubGlzdChwYXRoKS5waXBlKFxuICAgICAgLy8gRW1pdCBlYWNoIGZyYWdtZW50IGluZGl2aWR1YWxseS5cbiAgICAgIGNvbmNhdE1hcChmcmFnbWVudHMgPT4gZnJvbShmcmFnbWVudHMpKSxcbiAgICAgIC8vIEpvaW4gdGhlIHBhdGggd2l0aCBmcmFnbWVudC5cbiAgICAgIG1hcChmcmFnbWVudCA9PiBqb2luKHBhdGgsIGZyYWdtZW50KSksXG4gICAgICAvLyBFbWl0IGRpcmVjdG9yeSBjb250ZW50IHBhdGhzIGluc3RlYWQgb2YgdGhlIGRpcmVjdG9yeSBwYXRoLlxuICAgICAgbWVyZ2VNYXAocGF0aCA9PiB0aGlzLl9ob3N0LmlzRGlyZWN0b3J5KHBhdGgpLnBpcGUoXG4gICAgICAgICAgY29uY2F0TWFwKGlzRGlyID0+IGlzRGlyID8gcmVjdXJzaXZlTGlzdChwYXRoKSA6IG9mKHBhdGgpKVxuICAgICAgICApXG4gICAgICApLFxuICAgICk7XG5cbiAgICByZXR1cm4gcmVjdXJzaXZlTGlzdCh0aGlzLl9yZXNvbHZlKHBhdGgpKS5waXBlKFxuICAgICAgbWFwKHBhdGggPT4gcGF0aC5yZXBsYWNlKHRoaXMuYmFzZSwgJycpKSxcbiAgICAgIHRvQXJyYXkoKSxcbiAgICApLnRvUHJvbWlzZSgpLnRoZW4oeCA9PiB4LCBfZXJyID0+IFtdKTtcbiAgfVxuXG4gIHJlYWQocGF0aDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gdGhpcy5fcmVhZEludG9CdWZmZXIocGF0aClcbiAgICAgIC50aGVuKGNvbnRlbnQgPT4gdmlydHVhbEZzLmZpbGVCdWZmZXJUb1N0cmluZyhjb250ZW50KSk7XG4gIH1cblxuICBoYXNoKHBhdGg6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3Qgc2hhMSA9IGNyeXB0by5jcmVhdGVIYXNoKCdzaGExJyk7XG5cbiAgICByZXR1cm4gdGhpcy5fcmVhZEludG9CdWZmZXIocGF0aClcbiAgICAgIC50aGVuKGNvbnRlbnQgPT4gc2hhMS51cGRhdGUoQnVmZmVyLmZyb20oY29udGVudCkpKVxuICAgICAgLnRoZW4oKCkgPT4gc2hhMS5kaWdlc3QoJ2hleCcpKTtcbiAgfVxuXG4gIHdyaXRlKHBhdGg6IHN0cmluZywgY29udGVudDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIHRoaXMuX2hvc3Qud3JpdGUodGhpcy5fcmVzb2x2ZShwYXRoKSwgdmlydHVhbEZzLnN0cmluZ1RvRmlsZUJ1ZmZlcihjb250ZW50KSlcbiAgICAgIC50b1Byb21pc2UoKTtcbiAgfVxuXG4gIHByaXZhdGUgX3JlYWRJbnRvQnVmZmVyKHBhdGg6IHN0cmluZyk6IFByb21pc2U8dmlydHVhbEZzLkZpbGVCdWZmZXI+IHtcbiAgICByZXR1cm4gdGhpcy5faG9zdC5yZWFkKHRoaXMuX3Jlc29sdmUocGF0aCkpXG4gICAgICAudG9Qcm9taXNlKCk7XG4gIH1cblxuICBwcml2YXRlIF9yZXNvbHZlKHBhdGg6IHN0cmluZyk6IFBhdGgge1xuICAgIHJldHVybiBqb2luKG5vcm1hbGl6ZSh0aGlzLmJhc2UpLCBwYXRoKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gdXNlc1NlcnZpY2VXb3JrZXIocHJvamVjdFJvb3Q6IHN0cmluZyk6IGJvb2xlYW4ge1xuICBsZXQgc3dQYWNrYWdlSnNvblBhdGg7XG5cbiAgdHJ5IHtcbiAgICBzd1BhY2thZ2VKc29uUGF0aCA9IHJlc29sdmVQcm9qZWN0TW9kdWxlKHByb2plY3RSb290LCAnQGFuZ3VsYXIvc2VydmljZS13b3JrZXIvcGFja2FnZS5qc29uJyk7XG4gIH0gY2F0Y2ggKF8pIHtcbiAgICAvLyBAYW5ndWxhci9zZXJ2aWNlLXdvcmtlciBpcyBub3QgaW5zdGFsbGVkXG4gICAgdGhyb3cgbmV3IEVycm9yKHRhZ3Muc3RyaXBJbmRlbnRgXG4gICAgWW91ciBwcm9qZWN0IGlzIGNvbmZpZ3VyZWQgd2l0aCBzZXJ2aWNlV29ya2VyID0gdHJ1ZSwgYnV0IEBhbmd1bGFyL3NlcnZpY2Utd29ya2VyXG4gICAgaXMgbm90IGluc3RhbGxlZC4gUnVuIFxcYG5wbSBpbnN0YWxsIC0tc2F2ZS1kZXYgQGFuZ3VsYXIvc2VydmljZS13b3JrZXJcXGBcbiAgICBhbmQgdHJ5IGFnYWluLCBvciBydW4gXFxgbmcgc2V0IGFwcHMuMC5zZXJ2aWNlV29ya2VyPWZhbHNlXFxgIGluIHlvdXIgLmFuZ3VsYXItY2xpLmpzb24uXG4gIGApO1xuICB9XG5cbiAgY29uc3Qgc3dQYWNrYWdlSnNvbiA9IGZzLnJlYWRGaWxlU3luYyhzd1BhY2thZ2VKc29uUGF0aCkudG9TdHJpbmcoKTtcbiAgY29uc3Qgc3dWZXJzaW9uID0gSlNPTi5wYXJzZShzd1BhY2thZ2VKc29uKVsndmVyc2lvbiddO1xuXG4gIGlmICghc2VtdmVyLmd0ZShzd1ZlcnNpb24sIE5FV19TV19WRVJTSU9OKSkge1xuICAgIHRocm93IG5ldyBFcnJvcih0YWdzLnN0cmlwSW5kZW50YFxuICAgIFRoZSBpbnN0YWxsZWQgdmVyc2lvbiBvZiBAYW5ndWxhci9zZXJ2aWNlLXdvcmtlciBpcyAke3N3VmVyc2lvbn0uIFRoaXMgdmVyc2lvbiBvZiB0aGUgQ0xJXG4gICAgcmVxdWlyZXMgdGhlIEBhbmd1bGFyL3NlcnZpY2Utd29ya2VyIHZlcnNpb24gdG8gc2F0aXNmeSAke05FV19TV19WRVJTSU9OfS4gUGxlYXNlIHVwZ3JhZGVcbiAgICB5b3VyIHNlcnZpY2Ugd29ya2VyIHZlcnNpb24uXG4gIGApO1xuICB9XG5cbiAgcmV0dXJuIHRydWU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhdWdtZW50QXBwV2l0aFNlcnZpY2VXb3JrZXIoXG4gIGhvc3Q6IHZpcnR1YWxGcy5Ib3N0LFxuICBwcm9qZWN0Um9vdDogUGF0aCxcbiAgYXBwUm9vdDogUGF0aCxcbiAgb3V0cHV0UGF0aDogUGF0aCxcbiAgYmFzZUhyZWY6IHN0cmluZyxcbiAgbmdzd0NvbmZpZ1BhdGg/OiBzdHJpbmcsXG4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgLy8gUGF0aCB0byB0aGUgd29ya2VyIHNjcmlwdCBpdHNlbGYuXG4gIGNvbnN0IGRpc3RQYXRoID0gbm9ybWFsaXplKG91dHB1dFBhdGgpO1xuICBjb25zdCB3b3JrZXJQYXRoID0gbm9ybWFsaXplKFxuICAgIHJlc29sdmVQcm9qZWN0TW9kdWxlKGdldFN5c3RlbVBhdGgocHJvamVjdFJvb3QpLCAnQGFuZ3VsYXIvc2VydmljZS13b3JrZXIvbmdzdy13b3JrZXIuanMnKSxcbiAgKTtcbiAgY29uc3Qgc3dDb25maWdQYXRoID0gcmVzb2x2ZVByb2plY3RNb2R1bGUoXG4gICAgZ2V0U3lzdGVtUGF0aChwcm9qZWN0Um9vdCksXG4gICAgJ0Bhbmd1bGFyL3NlcnZpY2Utd29ya2VyL2NvbmZpZycsXG4gICk7XG4gIGNvbnN0IHNhZmV0eVBhdGggPSBqb2luKGRpcm5hbWUod29ya2VyUGF0aCksICdzYWZldHktd29ya2VyLmpzJyk7XG4gIGNvbnN0IGNvbmZpZ1BhdGggPSBuZ3N3Q29uZmlnUGF0aCBhcyBQYXRoIHx8IGpvaW4oYXBwUm9vdCwgJ25nc3ctY29uZmlnLmpzb24nKTtcblxuICByZXR1cm4gaG9zdC5leGlzdHMoY29uZmlnUGF0aCkucGlwZShcbiAgICBzd2l0Y2hNYXAoZXhpc3RzID0+IHtcbiAgICAgIGlmICghZXhpc3RzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcih0YWdzLm9uZUxpbmVgXG4gICAgICAgICAgRXJyb3I6IEV4cGVjdGVkIHRvIGZpbmQgYW4gbmdzdy1jb25maWcuanNvbiBjb25maWd1cmF0aW9uXG4gICAgICAgICAgZmlsZSBpbiB0aGUgJHthcHBSb290fSBmb2xkZXIuIEVpdGhlciBwcm92aWRlIG9uZSBvciBkaXNhYmxlIFNlcnZpY2UgV29ya2VyXG4gICAgICAgICAgaW4geW91ciBhbmd1bGFyLmpzb24gY29uZmlndXJhdGlvbiBmaWxlLmAsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBob3N0LnJlYWQoY29uZmlnUGF0aCkgYXMgT2JzZXJ2YWJsZTx2aXJ0dWFsRnMuRmlsZUJ1ZmZlcj47XG4gICAgfSksXG4gICAgbWFwKGNvbnRlbnQgPT4gSlNPTi5wYXJzZSh2aXJ0dWFsRnMuZmlsZUJ1ZmZlclRvU3RyaW5nKGNvbnRlbnQpKSksXG4gICAgc3dpdGNoTWFwKGNvbmZpZ0pzb24gPT4ge1xuICAgICAgY29uc3QgR2VuZXJhdG9yID0gcmVxdWlyZShzd0NvbmZpZ1BhdGgpLkdlbmVyYXRvcjtcbiAgICAgIGNvbnN0IGdlbiA9IG5ldyBHZW5lcmF0b3IobmV3IENsaUZpbGVzeXN0ZW0oaG9zdCwgb3V0cHV0UGF0aCksIGJhc2VIcmVmKTtcblxuICAgICAgcmV0dXJuIGdlbi5wcm9jZXNzKGNvbmZpZ0pzb24pO1xuICAgIH0pLFxuXG4gICAgc3dpdGNoTWFwKG91dHB1dCA9PiB7XG4gICAgICBjb25zdCBtYW5pZmVzdCA9IEpTT04uc3RyaW5naWZ5KG91dHB1dCwgbnVsbCwgMik7XG4gICAgICByZXR1cm4gaG9zdC5yZWFkKHdvcmtlclBhdGgpLnBpcGUoXG4gICAgICAgIHN3aXRjaE1hcCh3b3JrZXJDb2RlID0+IHtcbiAgICAgICAgICByZXR1cm4gbWVyZ2UoXG4gICAgICAgICAgICBob3N0LndyaXRlKGpvaW4oZGlzdFBhdGgsICduZ3N3Lmpzb24nKSwgdmlydHVhbEZzLnN0cmluZ1RvRmlsZUJ1ZmZlcihtYW5pZmVzdCkpLFxuICAgICAgICAgICAgaG9zdC53cml0ZShqb2luKGRpc3RQYXRoLCAnbmdzdy13b3JrZXIuanMnKSwgd29ya2VyQ29kZSksXG4gICAgICAgICAgKSBhcyBPYnNlcnZhYmxlPHZvaWQ+O1xuICAgICAgICB9KSxcbiAgICAgICk7XG4gICAgfSksXG5cbiAgICBzd2l0Y2hNYXAoKCkgPT4gaG9zdC5leGlzdHMoc2FmZXR5UGF0aCkpLFxuICAgIC8vIElmIEBhbmd1bGFyL3NlcnZpY2Utd29ya2VyIGhhcyB0aGUgc2FmZXR5IHNjcmlwdCwgY29weSBpdCBpbnRvIHR3byBsb2NhdGlvbnMuXG4gICAgc3dpdGNoTWFwKGV4aXN0cyA9PiB7XG4gICAgICBpZiAoIWV4aXN0cykge1xuICAgICAgICByZXR1cm4gb2Y8dm9pZD4odW5kZWZpbmVkKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGhvc3QucmVhZChzYWZldHlQYXRoKS5waXBlKFxuICAgICAgICBzd2l0Y2hNYXAoc2FmZXR5Q29kZSA9PiB7XG4gICAgICAgICAgcmV0dXJuIG1lcmdlKFxuICAgICAgICAgICAgaG9zdC53cml0ZShqb2luKGRpc3RQYXRoLCAnd29ya2VyLWJhc2ljLm1pbi5qcycpLCBzYWZldHlDb2RlKSxcbiAgICAgICAgICAgIGhvc3Qud3JpdGUoam9pbihkaXN0UGF0aCwgJ3NhZmV0eS13b3JrZXIuanMnKSwgc2FmZXR5Q29kZSksXG4gICAgICAgICAgKSBhcyBPYnNlcnZhYmxlPHZvaWQ+O1xuICAgICAgICB9KSxcbiAgICAgICk7XG4gICAgfSksXG5cbiAgICAvLyBSZW1vdmUgYWxsIGVsZW1lbnRzLCByZWR1Y2UgdGhlbSB0byBhIHNpbmdsZSBlbWl0LlxuICAgIHJlZHVjZSgoKSA9PiB7fSksXG4gICkudG9Qcm9taXNlKCk7XG59XG4iXX0=