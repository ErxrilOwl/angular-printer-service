"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
const ts = require("typescript");
const ast_helpers_1 = require("./ast_helpers");
const interfaces_1 = require("./interfaces");
const make_transform_1 = require("./make_transform");
function replaceResources(shouldTransform) {
    const standardTransform = function (sourceFile) {
        const ops = [];
        if (!shouldTransform(sourceFile.fileName)) {
            return ops;
        }
        const replacements = findResources(sourceFile);
        if (replacements.length > 0) {
            // Add the replacement operations.
            ops.push(...(replacements.map((rep) => rep.replaceNodeOperation)));
            // If we added a require call, we need to also add typings for it.
            // The typings need to be compatible with node typings, but also work by themselves.
            // interface NodeRequire {(id: string): any;}
            const nodeRequireInterface = ts.createInterfaceDeclaration([], [], 'NodeRequire', [], [], [
                ts.createCallSignature([], [
                    ts.createParameter([], [], undefined, 'id', undefined, ts.createKeywordTypeNode(ts.SyntaxKind.StringKeyword)),
                ], ts.createKeywordTypeNode(ts.SyntaxKind.AnyKeyword)),
            ]);
            // declare var require: NodeRequire;
            const varRequire = ts.createVariableStatement([ts.createToken(ts.SyntaxKind.DeclareKeyword)], [ts.createVariableDeclaration('require', ts.createTypeReferenceNode('NodeRequire', []))]);
            ops.push(new interfaces_1.AddNodeOperation(sourceFile, ast_helpers_1.getFirstNode(sourceFile), nodeRequireInterface));
            ops.push(new interfaces_1.AddNodeOperation(sourceFile, ast_helpers_1.getFirstNode(sourceFile), varRequire));
        }
        return ops;
    };
    return make_transform_1.makeTransform(standardTransform);
}
exports.replaceResources = replaceResources;
function findResources(sourceFile) {
    const replacements = [];
    // Find all object literals.
    ast_helpers_1.collectDeepNodes(sourceFile, ts.SyntaxKind.ObjectLiteralExpression)
        .map(node => ast_helpers_1.collectDeepNodes(node, ts.SyntaxKind.PropertyAssignment))
        .reduce((prev, curr) => curr ? prev.concat(curr) : prev, [])
        .filter((node) => {
        const key = _getContentOfKeyLiteral(node.name);
        if (!key) {
            // key is an expression, can't do anything.
            return false;
        }
        return key == 'templateUrl' || key == 'styleUrls';
    })
        .forEach((node) => {
        const key = _getContentOfKeyLiteral(node.name);
        if (key == 'templateUrl') {
            const resourcePath = _getResourceRequest(node.initializer, sourceFile);
            const requireCall = _createRequireCall(resourcePath);
            const propAssign = ts.createPropertyAssignment('template', requireCall);
            replacements.push({
                resourcePaths: [resourcePath],
                replaceNodeOperation: new interfaces_1.ReplaceNodeOperation(sourceFile, node, propAssign),
            });
        }
        else if (key == 'styleUrls') {
            const arr = ast_helpers_1.collectDeepNodes(node, ts.SyntaxKind.ArrayLiteralExpression);
            if (!arr || arr.length == 0 || arr[0].elements.length == 0) {
                return;
            }
            const stylePaths = arr[0].elements.map((element) => {
                return _getResourceRequest(element, sourceFile);
            });
            const requireArray = ts.createArrayLiteral(stylePaths.map((path) => _createRequireCall(path)));
            const propAssign = ts.createPropertyAssignment('styles', requireArray);
            replacements.push({
                resourcePaths: stylePaths,
                replaceNodeOperation: new interfaces_1.ReplaceNodeOperation(sourceFile, node, propAssign),
            });
        }
    });
    return replacements;
}
exports.findResources = findResources;
function _getContentOfKeyLiteral(node) {
    if (!node) {
        return null;
    }
    else if (node.kind == ts.SyntaxKind.Identifier) {
        return node.text;
    }
    else if (node.kind == ts.SyntaxKind.StringLiteral) {
        return node.text;
    }
    else {
        return null;
    }
}
function _getResourceRequest(element, sourceFile) {
    if (element.kind === ts.SyntaxKind.StringLiteral ||
        element.kind === ts.SyntaxKind.NoSubstitutionTemplateLiteral) {
        const url = element.text;
        // If the URL does not start with ./ or ../, prepends ./ to it.
        return `${/^\.?\.\//.test(url) ? '' : './'}${url}`;
    }
    else {
        // if not string, just use expression directly
        return element.getFullText(sourceFile);
    }
}
function _createRequireCall(path) {
    return ts.createCall(ts.createIdentifier('require'), [], [ts.createLiteral(path)]);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwbGFjZV9yZXNvdXJjZXMuanMiLCJzb3VyY2VSb290IjoiLi8iLCJzb3VyY2VzIjpbInBhY2thZ2VzL25ndG9vbHMvd2VicGFjay9zcmMvdHJhbnNmb3JtZXJzL3JlcGxhY2VfcmVzb3VyY2VzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7OztHQU1HO0FBQ0gsaUNBQWlDO0FBQ2pDLCtDQUErRDtBQUMvRCw2Q0FLc0I7QUFDdEIscURBQWlEO0FBR2pELDBCQUNFLGVBQThDO0lBRTlDLE1BQU0saUJBQWlCLEdBQXNCLFVBQVUsVUFBeUI7UUFDOUUsTUFBTSxHQUFHLEdBQXlCLEVBQUUsQ0FBQztRQUVyQyxFQUFFLENBQUMsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzFDLE1BQU0sQ0FBQyxHQUFHLENBQUM7UUFDYixDQUFDO1FBRUQsTUFBTSxZQUFZLEdBQUcsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRS9DLEVBQUUsQ0FBQyxDQUFDLFlBQVksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUU1QixrQ0FBa0M7WUFDbEMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLG9CQUFvQixDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRW5FLGtFQUFrRTtZQUNsRSxvRkFBb0Y7WUFFcEYsNkNBQTZDO1lBQzdDLE1BQU0sb0JBQW9CLEdBQUcsRUFBRSxDQUFDLDBCQUEwQixDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsYUFBYSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUU7Z0JBQ3hGLEVBQUUsQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFLEVBQUU7b0JBQ3pCLEVBQUUsQ0FBQyxlQUFlLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLFNB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LENBQUMsU0FBUyxDQUFDLEVBQzlCLEVBQUUsRUFDRixDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FDekIsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5pbXBvcnQgKiBhcyB0cyBmcm9tICd0eXBlc2NyaXB0JztcbmltcG9ydCB7IGNvbGxlY3REZWVwTm9kZXMsIGdldEZpcnN0Tm9kZSB9IGZyb20gJy4vYXN0X2hlbHBlcnMnO1xuaW1wb3J0IHtcbiAgQWRkTm9kZU9wZXJhdGlvbixcbiAgUmVwbGFjZU5vZGVPcGVyYXRpb24sXG4gIFN0YW5kYXJkVHJhbnNmb3JtLFxuICBUcmFuc2Zvcm1PcGVyYXRpb24sXG59IGZyb20gJy4vaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBtYWtlVHJhbnNmb3JtIH0gZnJvbSAnLi9tYWtlX3RyYW5zZm9ybSc7XG5cblxuZXhwb3J0IGZ1bmN0aW9uIHJlcGxhY2VSZXNvdXJjZXMoXG4gIHNob3VsZFRyYW5zZm9ybTogKGZpbGVOYW1lOiBzdHJpbmcpID0+IGJvb2xlYW4sXG4pOiB0cy5UcmFuc2Zvcm1lckZhY3Rvcnk8dHMuU291cmNlRmlsZT4ge1xuICBjb25zdCBzdGFuZGFyZFRyYW5zZm9ybTogU3RhbmRhcmRUcmFuc2Zvcm0gPSBmdW5jdGlvbiAoc291cmNlRmlsZTogdHMuU291cmNlRmlsZSkge1xuICAgIGNvbnN0IG9wczogVHJhbnNmb3JtT3BlcmF0aW9uW10gPSBbXTtcblxuICAgIGlmICghc2hvdWxkVHJhbnNmb3JtKHNvdXJjZUZpbGUuZmlsZU5hbWUpKSB7XG4gICAgICByZXR1cm4gb3BzO1xuICAgIH1cblxuICAgIGNvbnN0IHJlcGxhY2VtZW50cyA9IGZpbmRSZXNvdXJjZXMoc291cmNlRmlsZSk7XG5cbiAgICBpZiAocmVwbGFjZW1lbnRzLmxlbmd0aCA+IDApIHtcblxuICAgICAgLy8gQWRkIHRoZSByZXBsYWNlbWVudCBvcGVyYXRpb25zLlxuICAgICAgb3BzLnB1c2goLi4uKHJlcGxhY2VtZW50cy5tYXAoKHJlcCkgPT4gcmVwLnJlcGxhY2VOb2RlT3BlcmF0aW9uKSkpO1xuXG4gICAgICAvLyBJZiB3ZSBhZGRlZCBhIHJlcXVpcmUgY2FsbCwgd2UgbmVlZCB0byBhbHNvIGFkZCB0eXBpbmdzIGZvciBpdC5cbiAgICAgIC8vIFRoZSB0eXBpbmdzIG5lZWQgdG8gYmUgY29tcGF0aWJsZSB3aXRoIG5vZGUgdHlwaW5ncywgYnV0IGFsc28gd29yayBieSB0aGVtc2VsdmVzLlxuXG4gICAgICAvLyBpbnRlcmZhY2UgTm9kZVJlcXVpcmUgeyhpZDogc3RyaW5nKTogYW55O31cbiAgICAgIGNvbnN0IG5vZGVSZXF1aXJlSW50ZXJmYWNlID0gdHMuY3JlYXRlSW50ZXJmYWNlRGVjbGFyYXRpb24oW10sIFtdLCAnTm9kZVJlcXVpcmUnLCBbXSwgW10sIFtcbiAgICAgICAgdHMuY3JlYXRlQ2FsbFNpZ25hdHVyZShbXSwgW1xuICAgICAgICAgIHRzLmNyZWF0ZVBhcmFtZXRlcihbXSwgW10sIHVuZGVmaW5lZCwgJ2lkJywgdW5kZWZpbmVkLFxuICAgICAgICAgICAgdHMuY3JlYXRlS2V5d29yZFR5cGVOb2RlKHRzLlN5bnRheEtpbmQuU3RyaW5nS2V5d29yZCksXG4gICAgICAgICAgKSxcbiAgICAgICAgXSwgdHMuY3JlYXRlS2V5d29yZFR5cGVOb2RlKHRzLlN5bnRheEtpbmQuQW55S2V5d29yZCkpLFxuICAgICAgXSk7XG5cbiAgICAgIC8vIGRlY2xhcmUgdmFyIHJlcXVpcmU6IE5vZGVSZXF1aXJlO1xuICAgICAgY29uc3QgdmFyUmVxdWlyZSA9IHRzLmNyZWF0ZVZhcmlhYmxlU3RhdGVtZW50KFxuICAgICAgICBbdHMuY3JlYXRlVG9rZW4odHMuU3ludGF4S2luZC5EZWNsYXJlS2V5d29yZCldLFxuICAgICAgICBbdHMuY3JlYXRlVmFyaWFibGVEZWNsYXJhdGlvbigncmVxdWlyZScsIHRzLmNyZWF0ZVR5cGVSZWZlcmVuY2VOb2RlKCdOb2RlUmVxdWlyZScsIFtdKSldLFxuICAgICAgKTtcblxuICAgICAgb3BzLnB1c2gobmV3IEFkZE5vZGVPcGVyYXRpb24oc291cmNlRmlsZSwgZ2V0Rmlyc3ROb2RlKHNvdXJjZUZpbGUpLCBub2RlUmVxdWlyZUludGVyZmFjZSkpO1xuICAgICAgb3BzLnB1c2gobmV3IEFkZE5vZGVPcGVyYXRpb24oc291cmNlRmlsZSwgZ2V0Rmlyc3ROb2RlKHNvdXJjZUZpbGUpLCB2YXJSZXF1aXJlKSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG9wcztcbiAgfTtcblxuICByZXR1cm4gbWFrZVRyYW5zZm9ybShzdGFuZGFyZFRyYW5zZm9ybSk7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVzb3VyY2VSZXBsYWNlbWVudCB7XG4gIHJlc291cmNlUGF0aHM6IHN0cmluZ1tdO1xuICByZXBsYWNlTm9kZU9wZXJhdGlvbjogUmVwbGFjZU5vZGVPcGVyYXRpb247XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmaW5kUmVzb3VyY2VzKHNvdXJjZUZpbGU6IHRzLlNvdXJjZUZpbGUpOiBSZXNvdXJjZVJlcGxhY2VtZW50W10ge1xuICBjb25zdCByZXBsYWNlbWVudHM6IFJlc291cmNlUmVwbGFjZW1lbnRbXSA9IFtdO1xuXG4gIC8vIEZpbmQgYWxsIG9iamVjdCBsaXRlcmFscy5cbiAgY29sbGVjdERlZXBOb2Rlczx0cy5PYmplY3RMaXRlcmFsRXhwcmVzc2lvbj4oc291cmNlRmlsZSwgdHMuU3ludGF4S2luZC5PYmplY3RMaXRlcmFsRXhwcmVzc2lvbilcbiAgICAvLyBHZXQgYWxsIHRoZWlyIHByb3BlcnR5IGFzc2lnbm1lbnRzLlxuICAgIC5tYXAobm9kZSA9PiBjb2xsZWN0RGVlcE5vZGVzPHRzLlByb3BlcnR5QXNzaWdubWVudD4obm9kZSwgdHMuU3ludGF4S2luZC5Qcm9wZXJ0eUFzc2lnbm1lbnQpKVxuICAgIC8vIEZsYXR0ZW4gaW50byBhIHNpbmdsZSBhcnJheSAoZnJvbSBhbiBhcnJheSBvZiBhcnJheTxwcm9wZXJ0eSBhc3NpZ25tZW50cz4pLlxuICAgIC5yZWR1Y2UoKHByZXYsIGN1cnIpID0+IGN1cnIgPyBwcmV2LmNvbmNhdChjdXJyKSA6IHByZXYsIFtdKVxuICAgIC8vIFdlIG9ubHkgd2FudCBwcm9wZXJ0eSBhc3NpZ25tZW50cyBmb3IgdGhlIHRlbXBsYXRlVXJsL3N0eWxlVXJscyBrZXlzLlxuICAgIC5maWx0ZXIoKG5vZGU6IHRzLlByb3BlcnR5QXNzaWdubWVudCkgPT4ge1xuICAgICAgY29uc3Qga2V5ID0gX2dldENvbnRlbnRPZktleUxpdGVyYWwobm9kZS5uYW1lKTtcbiAgICAgIGlmICgha2V5KSB7XG4gICAgICAgIC8vIGtleSBpcyBhbiBleHByZXNzaW9uLCBjYW4ndCBkbyBhbnl0aGluZy5cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4ga2V5ID09ICd0ZW1wbGF0ZVVybCcgfHwga2V5ID09ICdzdHlsZVVybHMnO1xuICAgIH0pXG4gICAgLy8gUmVwbGFjZSB0ZW1wbGF0ZVVybC9zdHlsZVVybHMga2V5IHdpdGggdGVtcGxhdGUvc3R5bGVzLCBhbmQgYW5kIHBhdGhzIHdpdGggcmVxdWlyZSgncGF0aCcpLlxuICAgIC5mb3JFYWNoKChub2RlOiB0cy5Qcm9wZXJ0eUFzc2lnbm1lbnQpID0+IHtcbiAgICAgIGNvbnN0IGtleSA9IF9nZXRDb250ZW50T2ZLZXlMaXRlcmFsKG5vZGUubmFtZSk7XG5cbiAgICAgIGlmIChrZXkgPT0gJ3RlbXBsYXRlVXJsJykge1xuICAgICAgICBjb25zdCByZXNvdXJjZVBhdGggPSBfZ2V0UmVzb3VyY2VSZXF1ZXN0KG5vZGUuaW5pdGlhbGl6ZXIsIHNvdXJjZUZpbGUpO1xuICAgICAgICBjb25zdCByZXF1aXJlQ2FsbCA9IF9jcmVhdGVSZXF1aXJlQ2FsbChyZXNvdXJjZVBhdGgpO1xuICAgICAgICBjb25zdCBwcm9wQXNzaWduID0gdHMuY3JlYXRlUHJvcGVydHlBc3NpZ25tZW50KCd0ZW1wbGF0ZScsIHJlcXVpcmVDYWxsKTtcbiAgICAgICAgcmVwbGFjZW1lbnRzLnB1c2goe1xuICAgICAgICAgIHJlc291cmNlUGF0aHM6IFtyZXNvdXJjZVBhdGhdLFxuICAgICAgICAgIHJlcGxhY2VOb2RlT3BlcmF0aW9uOiBuZXcgUmVwbGFjZU5vZGVPcGVyYXRpb24oc291cmNlRmlsZSwgbm9kZSwgcHJvcEFzc2lnbiksXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIGlmIChrZXkgPT0gJ3N0eWxlVXJscycpIHtcbiAgICAgICAgY29uc3QgYXJyID0gY29sbGVjdERlZXBOb2Rlczx0cy5BcnJheUxpdGVyYWxFeHByZXNzaW9uPihub2RlLFxuICAgICAgICAgIHRzLlN5bnRheEtpbmQuQXJyYXlMaXRlcmFsRXhwcmVzc2lvbik7XG4gICAgICAgIGlmICghYXJyIHx8IGFyci5sZW5ndGggPT0gMCB8fCBhcnJbMF0uZWxlbWVudHMubGVuZ3RoID09IDApIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzdHlsZVBhdGhzID0gYXJyWzBdLmVsZW1lbnRzLm1hcCgoZWxlbWVudDogdHMuRXhwcmVzc2lvbikgPT4ge1xuICAgICAgICAgIHJldHVybiBfZ2V0UmVzb3VyY2VSZXF1ZXN0KGVsZW1lbnQsIHNvdXJjZUZpbGUpO1xuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCByZXF1aXJlQXJyYXkgPSB0cy5jcmVhdGVBcnJheUxpdGVyYWwoXG4gICAgICAgICAgc3R5bGVQYXRocy5tYXAoKHBhdGgpID0+IF9jcmVhdGVSZXF1aXJlQ2FsbChwYXRoKSksXG4gICAgICAgICk7XG5cbiAgICAgICAgY29uc3QgcHJvcEFzc2lnbiA9IHRzLmNyZWF0ZVByb3BlcnR5QXNzaWdubWVudCgnc3R5bGVzJywgcmVxdWlyZUFycmF5KTtcbiAgICAgICAgcmVwbGFjZW1lbnRzLnB1c2goe1xuICAgICAgICAgIHJlc291cmNlUGF0aHM6IHN0eWxlUGF0aHMsXG4gICAgICAgICAgcmVwbGFjZU5vZGVPcGVyYXRpb246IG5ldyBSZXBsYWNlTm9kZU9wZXJhdGlvbihzb3VyY2VGaWxlLCBub2RlLCBwcm9wQXNzaWduKSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgcmV0dXJuIHJlcGxhY2VtZW50cztcblxufVxuXG5mdW5jdGlvbiBfZ2V0Q29udGVudE9mS2V5TGl0ZXJhbChub2RlPzogdHMuTm9kZSk6IHN0cmluZyB8IG51bGwge1xuICBpZiAoIW5vZGUpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfSBlbHNlIGlmIChub2RlLmtpbmQgPT0gdHMuU3ludGF4S2luZC5JZGVudGlmaWVyKSB7XG4gICAgcmV0dXJuIChub2RlIGFzIHRzLklkZW50aWZpZXIpLnRleHQ7XG4gIH0gZWxzZSBpZiAobm9kZS5raW5kID09IHRzLlN5bnRheEtpbmQuU3RyaW5nTGl0ZXJhbCkge1xuICAgIHJldHVybiAobm9kZSBhcyB0cy5TdHJpbmdMaXRlcmFsKS50ZXh0O1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBudWxsO1xuICB9XG59XG5cbmZ1bmN0aW9uIF9nZXRSZXNvdXJjZVJlcXVlc3QoZWxlbWVudDogdHMuRXhwcmVzc2lvbiwgc291cmNlRmlsZTogdHMuU291cmNlRmlsZSkge1xuICBpZiAoXG4gICAgZWxlbWVudC5raW5kID09PSB0cy5TeW50YXhLaW5kLlN0cmluZ0xpdGVyYWwgfHxcbiAgICBlbGVtZW50LmtpbmQgPT09IHRzLlN5bnRheEtpbmQuTm9TdWJzdGl0dXRpb25UZW1wbGF0ZUxpdGVyYWxcbiAgKSB7XG4gICAgY29uc3QgdXJsID0gKGVsZW1lbnQgYXMgdHMuU3RyaW5nTGl0ZXJhbCkudGV4dDtcblxuICAgIC8vIElmIHRoZSBVUkwgZG9lcyBub3Qgc3RhcnQgd2l0aCAuLyBvciAuLi8sIHByZXBlbmRzIC4vIHRvIGl0LlxuICAgIHJldHVybiBgJHsvXlxcLj9cXC5cXC8vLnRlc3QodXJsKSA/ICcnIDogJy4vJ30ke3VybH1gO1xuICB9IGVsc2Uge1xuICAgIC8vIGlmIG5vdCBzdHJpbmcsIGp1c3QgdXNlIGV4cHJlc3Npb24gZGlyZWN0bHlcbiAgICByZXR1cm4gZWxlbWVudC5nZXRGdWxsVGV4dChzb3VyY2VGaWxlKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBfY3JlYXRlUmVxdWlyZUNhbGwocGF0aDogc3RyaW5nKSB7XG4gIHJldHVybiB0cy5jcmVhdGVDYWxsKFxuICAgIHRzLmNyZWF0ZUlkZW50aWZpZXIoJ3JlcXVpcmUnKSxcbiAgICBbXSxcbiAgICBbdHMuY3JlYXRlTGl0ZXJhbChwYXRoKV0sXG4gICk7XG59XG4iXX0=