/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
import { DEFAULT_INTERPOLATION_CONFIG, DomElementSchemaRegistry, Lexer, Parser } from '../compiler';
import * as o from '../output/output_ast';
import { BindingParser } from '../template_parser/binding_parser';
import { compilePipe } from './r3_pipe_compiler';
import { BUILD_OPTIMIZER_REMOVE } from './r3_types';
import { compileComponent, compileDirective } from './r3_view_compiler';
/**
 * Produce the back-patching function for the given module to the output context.
 */
export function compileModuleBackPatch(outputCtx, name, module, kind, backPatchReferenceOf, parseTemplate, reflector, resolver) {
    const imports = [];
    let statements = [];
    // Call dependent back patching
    for (const importedModule of module.importedModules) {
        const importBackPatchFunction = backPatchReferenceOf(importedModule.type);
        // e.g. // @BUILD_OPTIMIZER_REMOVE
        imports.push(new o.CommentStmt(BUILD_OPTIMIZER_REMOVE));
        // e.g. ngBackPatch_some_other_module_Module();
        imports.push(importBackPatchFunction.callFn([]).toStmt());
    }
    // The local output context allows collecting the back-patch statements that
    // are generated by the various compilers which allows putting placing them
    // into the body of a function instead of at global scope.
    const localCtx = {
        statements,
        constantPool: outputCtx.constantPool,
        genFilePath: outputCtx.genFilePath,
        importExpr: outputCtx.importExpr
    };
    // e.g. export function ngBackPatch_some_module_Lib1Module()
    if (kind === 0 /* Renderer2 */) {
        // For all Renderer2 modules generate back-patching code for all the components, directives,
        // pipes, and injectables as well as the injector def for the module itself.
        const expressionParser = new Parser(new Lexer());
        const elementSchemaRegistry = new DomElementSchemaRegistry();
        const errors = [];
        const hostBindingParser = new BindingParser(expressionParser, DEFAULT_INTERPOLATION_CONFIG, elementSchemaRegistry, [], errors);
        // Back-patch all declared directive and components
        for (const declaredDirective of module.declaredDirectives) {
            const declaredDirectiveMetadata = resolver.getDirectiveMetadata(declaredDirective.reference);
            if (declaredDirectiveMetadata.isComponent) {
                const { template: parsedTemplate, pipes: parsedPipes } = parseTemplate(declaredDirectiveMetadata, module, module.transitiveModule.directives);
                compileComponent(localCtx, declaredDirectiveMetadata, parsedPipes, parsedTemplate, reflector, hostBindingParser, 1 /* BackPatch */);
            }
            else {
                compileDirective(localCtx, declaredDirectiveMetadata, reflector, hostBindingParser, 1 /* BackPatch */);
            }
        }
        // Back-patch all pipes declared in the module.
        for (const pipeType of module.declaredPipes) {
            const pipeMetadata = resolver.getPipeMetadata(pipeType.reference);
            if (pipeMetadata) {
                compilePipe(localCtx, pipeMetadata, reflector, 1 /* BackPatch */);
            }
        }
        if (errors.length) {
            throw new Error(errors.map(e => e.toString()).join('\n'));
        }
    }
    outputCtx.statements.push(new o.DeclareFunctionStmt(name, [], [...imports, ...statements], o.INFERRED_TYPE, [o.StmtModifier.Exported]));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicjNfYmFja19wYXRjaF9jb21waWxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2NvbXBpbGVyL3NyYy9yZW5kZXIzL3IzX2JhY2tfcGF0Y2hfY29tcGlsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HO0FBSUgsT0FBTyxFQUFDLDRCQUE0QixFQUFFLHdCQUF3QixFQUFFLEtBQUssRUFBYyxNQUFNLEVBQUMsTUFBTSxhQUFhLENBQUM7QUFFOUcsT0FBTyxLQUFLLENBQUMsTUFBTSxzQkFBc0IsQ0FBQztBQUMxQyxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sbUNBQW1DLENBQUM7QUFJaEUsT0FBTyxFQUFDLFdBQVcsRUFBQyxNQUFNLG9CQUFvQixDQUFDO0FBQy9DLE9BQU8sRUFBQyxzQkFBc0IsRUFBYSxNQUFNLFlBQVksQ0FBQztBQUM5RCxPQUFPLEVBQUMsZ0JBQWdCLEVBQUUsZ0JBQWdCLEVBQUMsTUFBTSxvQkFBb0IsQ0FBQztBQU90RTs7R0FFRztBQUNILE1BQU0saUNBQ0YsU0FBd0IsRUFBRSxJQUFZLEVBQUUsTUFBK0IsRUFBRSxJQUFnQixFQUN6RixvQkFBbUUsRUFDbkUsYUFLQyxFQUNELFNBQTBCLEVBQUUsUUFBaUM7SUFDL0QsTUFBTSxPQUFPLEdBQWtCLEVBQUUsQ0FBQztJQUNsQyxJQUFJLFVBQVUsR0FBa0IsRUFBRSxDQUFDO0lBRW5DLCtCQUErQjtJQUMvQixHQUFHLENBQUMsQ0FBQyxNQUFNLGNBQWMsSUFBSSxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztRQUNwRCxNQUFNLHVCQUF1QixHQUFHLG9CQUFvQixDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUUxRSxrQ0FBa0M7UUFDbEMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxXQUFXLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxDQUFDO1FBRXhELCtD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O0FBQzFGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5cbmltcG9ydCB7U3RhdGljUmVmbGVjdG9yfSBmcm9tICcuLi9hb3Qvc3RhdGljX3JlZmxlY3Rvcic7XG5pbXBvcnQge0NvbXBpbGVEaXJlY3RpdmVNZXRhZGF0YSwgQ29tcGlsZUlkZW50aWZpZXJNZXRhZGF0YSwgQ29tcGlsZU5nTW9kdWxlTWV0YWRhdGEsIENvbXBpbGVQaXBlU3VtbWFyeSwgQ29tcGlsZVR5cGVNZXRhZGF0YX0gZnJvbSAnLi4vY29tcGlsZV9tZXRhZGF0YSc7XG5pbXBvcnQge0RFRkFVTFRfSU5URVJQT0xBVElPTl9DT05GSUcsIERvbUVsZW1lbnRTY2hlbWFSZWdpc3RyeSwgTGV4ZXIsIFBhcnNlRXJyb3IsIFBhcnNlcn0gZnJvbSAnLi4vY29tcGlsZXInO1xuaW1wb3J0IHtDb21waWxlTWV0YWRhdGFSZXNvbHZlcn0gZnJvbSAnLi4vbWV0YWRhdGFfcmVzb2x2ZXInO1xuaW1wb3J0ICogYXMgbyBmcm9tICcuLi9vdXRwdXQvb3V0cHV0X2FzdCc7XG5pbXBvcnQge0JpbmRpbmdQYXJzZXJ9IGZyb20gJy4uL3RlbXBsYXRlX3BhcnNlci9iaW5kaW5nX3BhcnNlcic7XG5pbXBvcnQge1RlbXBsYXRlQXN0fSBmcm9tICcuLi90ZW1wbGF0ZV9wYXJzZXIvdGVtcGxhdGVfYXN0JztcbmltcG9ydCB7T3V0cHV0Q29udGV4dH0gZnJvbSAnLi4vdXRpbCc7XG5cbmltcG9ydCB7Y29tcGlsZVBpcGV9IGZyb20gJy4vcjNfcGlwZV9jb21waWxlcic7XG5pbXBvcnQge0JVSUxEX09QVElNSVpFUl9SRU1PVkUsIE91dHB1dE1vZGV9IGZyb20gJy4vcjNfdHlwZXMnO1xuaW1wb3J0IHtjb21waWxlQ29tcG9uZW50LCBjb21waWxlRGlyZWN0aXZlfSBmcm9tICcuL3IzX3ZpZXdfY29tcGlsZXInO1xuXG5leHBvcnQgY29uc3QgZW51bSBNb2R1bGVLaW5kIHtcbiAgUmVuZGVyZXIyLFxuICBSZW5kZXJlcjMsXG59XG5cbi8qKlxuICogUHJvZHVjZSB0aGUgYmFjay1wYXRjaGluZyBmdW5jdGlvbiBmb3IgdGhlIGdpdmVuIG1vZHVsZSB0byB0aGUgb3V0cHV0IGNvbnRleHQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjb21waWxlTW9kdWxlQmFja1BhdGNoKFxuICAgIG91dHB1dEN0eDogT3V0cHV0Q29udGV4dCwgbmFtZTogc3RyaW5nLCBtb2R1bGU6IENvbXBpbGVOZ01vZHVsZU1ldGFkYXRhLCBraW5kOiBNb2R1bGVLaW5kLFxuICAgIGJhY2tQYXRjaFJlZmVyZW5jZU9mOiAobW9kdWxlOiBDb21waWxlVHlwZU1ldGFkYXRhKSA9PiBvLkV4cHJlc3Npb24sXG4gICAgcGFyc2VUZW1wbGF0ZTogKFxuICAgICAgICBjb21wTWV0YTogQ29tcGlsZURpcmVjdGl2ZU1ldGFkYXRhLCBuZ01vZHVsZTogQ29tcGlsZU5nTW9kdWxlTWV0YWRhdGEsXG4gICAgICAgIGRpcmVjdGl2ZUlkZW50aWZpZXJzOiBDb21waWxlSWRlbnRpZmllck1ldGFkYXRhW10pID0+IHtcbiAgICAgIHRlbXBsYXRlOiBUZW1wbGF0ZUFzdFtdLFxuICAgICAgcGlwZXM6IENvbXBpbGVQaXBlU3VtbWFyeVtdXG4gICAgfSxcbiAgICByZWZsZWN0b3I6IFN0YXRpY1JlZmxlY3RvciwgcmVzb2x2ZXI6IENvbXBpbGVNZXRhZGF0YVJlc29sdmVyKSB7XG4gIGNvbnN0IGltcG9ydHM6IG8uU3RhdGVtZW50W10gPSBbXTtcbiAgbGV0IHN0YXRlbWVudHM6IG8uU3RhdGVtZW50W10gPSBbXTtcblxuICAvLyBDYWxsIGRlcGVuZGVudCBiYWNrIHBhdGNoaW5nXG4gIGZvciAoY29uc3QgaW1wb3J0ZWRNb2R1bGUgb2YgbW9kdWxlLmltcG9ydGVkTW9kdWxlcykge1xuICAgIGNvbnN0IGltcG9ydEJhY2tQYXRjaEZ1bmN0aW9uID0gYmFja1BhdGNoUmVmZXJlbmNlT2YoaW1wb3J0ZWRNb2R1bGUudHlwZSk7XG5cbiAgICAvLyBlLmcuIC8vIEBCVUlMRF9PUFRJTUlaRVJfUkVNT1ZFXG4gICAgaW1wb3J0cy5wdXNoKG5ldyBvLkNvbW1lbnRTdG10KEJVSUxEX09QVElNSVpFUl9SRU1PVkUpKTtcblxuICAgIC8vIGUuZy4gbmdCYWNrUGF0Y2hfc29tZV9vdGhlcl9tb2R1bGVfTW9kdWxlKCk7XG4gICAgaW1wb3J0cy5wdXNoKGltcG9ydEJhY2tQYXRjaEZ1bmN0aW9uLmNhbGxGbihbXSkudG9TdG10KCkpO1xuICB9XG5cbiAgLy8gVGhlIGxvY2FsIG91dHB1dCBjb250ZXh0IGFsbG93cyBjb2xsZWN0aW5nIHRoZSBiYWNrLXBhdGNoIHN0YXRlbWVudHMgdGhhdFxuICAvLyBhcmUgZ2VuZXJhdGVkIGJ5IHRoZSB2YXJpb3VzIGNvbXBpbGVycyB3aGljaCBhbGxvd3MgcHV0dGluZyBwbGFjaW5nIHRoZW1cbiAgLy8gaW50byB0aGUgYm9keSBvZiBhIGZ1bmN0aW9uIGluc3RlYWQgb2YgYXQgZ2xvYmFsIHNjb3BlLlxuICBjb25zdCBsb2NhbEN0eDogT3V0cHV0Q29udGV4dCA9IHtcbiAgICBzdGF0ZW1lbnRzLFxuICAgIGNvbnN0YW50UG9vbDogb3V0cHV0Q3R4LmNvbnN0YW50UG9vbCxcbiAgICBnZW5GaWxlUGF0aDogb3V0cHV0Q3R4LmdlbkZpbGVQYXRoLFxuICAgIGltcG9ydEV4cHI6IG91dHB1dEN0eC5pbXBvcnRFeHByXG4gIH07XG5cbiAgLy8gZS5nLiBleHBvcnQgZnVuY3Rpb24gbmdCYWNrUGF0Y2hfc29tZV9tb2R1bGVfTGliMU1vZHVsZSgpXG4gIGlmIChraW5kID09PSBNb2R1bGVLaW5kLlJlbmRlcmVyMikge1xuICAgIC8vIEZvciBhbGwgUmVuZGVyZXIyIG1vZHVsZXMgZ2VuZXJhdGUgYmFjay1wYXRjaGluZyBjb2RlIGZvciBhbGwgdGhlIGNvbXBvbmVudHMsIGRpcmVjdGl2ZXMsXG4gICAgLy8gcGlwZXMsIGFuZCBpbmplY3RhYmxlcyBhcyB3ZWxsIGFzIHRoZSBpbmplY3RvciBkZWYgZm9yIHRoZSBtb2R1bGUgaXRzZWxmLlxuXG4gICAgY29uc3QgZXhwcmVzc2lvblBhcnNlciA9IG5ldyBQYXJzZXIobmV3IExleGVyKCkpO1xuICAgIGNvbnN0IGVsZW1lbnRTY2hlbWFSZWdpc3RyeSA9IG5ldyBEb21FbGVtZW50U2NoZW1hUmVnaXN0cnkoKTtcbiAgICBjb25zdCBlcnJvcnM6IFBhcnNlRXJyb3JbXSA9IFtdO1xuICAgIGNvbnN0IGhvc3RCaW5kaW5nUGFyc2VyID0gbmV3IEJpbmRpbmdQYXJzZXIoXG4gICAgICAgIGV4cHJlc3Npb25QYXJzZXIsIERFRkFVTFRfSU5URVJQT0xBVElPTl9DT05GSUcsIGVsZW1lbnRTY2hlbWFSZWdpc3RyeSwgW10sIGVycm9ycyk7XG5cbiAgICAvLyBCYWNrLXBhdGNoIGFsbCBkZWNsYXJlZCBkaXJlY3RpdmUgYW5kIGNvbXBvbmVudHNcbiAgICBmb3IgKGNvbnN0IGRlY2xhcmVkRGlyZWN0aXZlIG9mIG1vZHVsZS5kZWNsYXJlZERpcmVjdGl2ZXMpIHtcbiAgICAgIGNvbnN0IGRlY2xhcmVkRGlyZWN0aXZlTWV0YWRhdGEgPSByZXNvbHZlci5nZXREaXJlY3RpdmVNZXRhZGF0YShkZWNsYXJlZERpcmVjdGl2ZS5yZWZlcmVuY2UpO1xuICAgICAgaWYgKGRlY2xhcmVkRGlyZWN0aXZlTWV0YWRhdGEuaXNDb21wb25lbnQpIHtcbiAgICAgICAgY29uc3Qge3RlbXBsYXRlOiBwYXJzZWRUZW1wbGF0ZSwgcGlwZXM6IHBhcnNlZFBpcGVzfSA9XG4gICAgICAgICAgICBwYXJzZVRlbXBsYXRlKGRlY2xhcmVkRGlyZWN0aXZlTWV0YWRhdGEsIG1vZHVsZSwgbW9kdWxlLnRyYW5zaXRpdmVNb2R1bGUuZGlyZWN0aXZlcyk7XG4gICAgICAgIGNvbXBpbGVDb21wb25lbnQoXG4gICAgICAgICAgICBsb2NhbEN0eCwgZGVjbGFyZWREaXJlY3RpdmVNZXRhZGF0YSwgcGFyc2VkUGlwZXMsIHBhcnNlZFRlbXBsYXRlLCByZWZsZWN0b3IsXG4gICAgICAgICAgICBob3N0QmluZGluZ1BhcnNlciwgT3V0cHV0TW9kZS5CYWNrUGF0Y2gpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29tcGlsZURpcmVjdGl2ZShcbiAgICAgICAgICAgIGxvY2FsQ3R4LCBkZWNsYXJlZERpcmVjdGl2ZU1ldGFkYXRhLCByZWZsZWN0b3IsIGhvc3RCaW5kaW5nUGFyc2VyLFxuICAgICAgICAgICAgT3V0cHV0TW9kZS5CYWNrUGF0Y2gpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEJhY2stcGF0Y2ggYWxsIHBpcGVzIGRlY2xhcmVkIGluIHRoZSBtb2R1bGUuXG4gICAgZm9yIChjb25zdCBwaXBlVHlwZSBvZiBtb2R1bGUuZGVjbGFyZWRQaXBlcykge1xuICAgICAgY29uc3QgcGlwZU1ldGFkYXRhID0gcmVzb2x2ZXIuZ2V0UGlwZU1ldGFkYXRhKHBpcGVUeXBlLnJlZmVyZW5jZSk7XG4gICAgICBpZiAocGlwZU1ldGFkYXRhKSB7XG4gICAgICAgIGNvbXBpbGVQaXBlKGxvY2FsQ3R4LCBwaXBlTWV0YWRhdGEsIHJlZmxlY3RvciwgT3V0cHV0TW9kZS5CYWNrUGF0Y2gpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChlcnJvcnMubGVuZ3RoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JzLm1hcChlID0+IGUudG9TdHJpbmcoKSkuam9pbignXFxuJykpO1xuICAgIH1cbiAgfVxuXG4gIG91dHB1dEN0eC5zdGF0ZW1lbnRzLnB1c2gobmV3IG8uRGVjbGFyZUZ1bmN0aW9uU3RtdChcbiAgICAgIG5hbWUsIFtdLCBbLi4uaW1wb3J0cywgLi4uc3RhdGVtZW50c10sIG8uSU5GRVJSRURfVFlQRSwgW28uU3RtdE1vZGlmaWVyLkV4cG9ydGVkXSkpO1xufVxuIl19