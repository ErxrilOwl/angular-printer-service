/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
import * as tslib_1 from "tslib";
import { DEFAULT_INTERPOLATION_CONFIG, DomElementSchemaRegistry, Lexer, Parser } from '../compiler';
import * as o from '../output/output_ast';
import { BindingParser } from '../template_parser/binding_parser';
import { compilePipe } from './r3_pipe_compiler';
import { BUILD_OPTIMIZER_REMOVE } from './r3_types';
import { compileComponent, compileDirective } from './r3_view_compiler';
/**
 * Produce the back-patching function for the given module to the output context.
 */
export function compileModuleBackPatch(outputCtx, name, module, kind, backPatchReferenceOf, parseTemplate, reflector, resolver) {
    var imports = [];
    var statements = [];
    try {
        // Call dependent back patching
        for (var _a = tslib_1.__values(module.importedModules), _b = _a.next(); !_b.done; _b = _a.next()) {
            var importedModule = _b.value;
            var importBackPatchFunction = backPatchReferenceOf(importedModule.type);
            // e.g. // @BUILD_OPTIMIZER_REMOVE
            imports.push(new o.CommentStmt(BUILD_OPTIMIZER_REMOVE));
            // e.g. ngBackPatch_some_other_module_Module();
            imports.push(importBackPatchFunction.callFn([]).toStmt());
        }
    }
    catch (e_1_1) { e_1 = { error: e_1_1 }; }
    finally {
        try {
            if (_b && !_b.done && (_c = _a.return)) _c.call(_a);
        }
        finally { if (e_1) throw e_1.error; }
    }
    // The local output context allows collecting the back-patch statements that
    // are generated by the various compilers which allows putting placing them
    // into the body of a function instead of at global scope.
    var localCtx = {
        statements: statements,
        constantPool: outputCtx.constantPool,
        genFilePath: outputCtx.genFilePath,
        importExpr: outputCtx.importExpr
    };
    // e.g. export function ngBackPatch_some_module_Lib1Module()
    if (kind === 0 /* Renderer2 */) {
        // For all Renderer2 modules generate back-patching code for all the components, directives,
        // pipes, and injectables as well as the injector def for the module itself.
        var expressionParser = new Parser(new Lexer());
        var elementSchemaRegistry = new DomElementSchemaRegistry();
        var errors = [];
        var hostBindingParser = new BindingParser(expressionParser, DEFAULT_INTERPOLATION_CONFIG, elementSchemaRegistry, [], errors);
        try {
            // Back-patch all declared directive and components
            for (var _d = tslib_1.__values(module.declaredDirectives), _e = _d.next(); !_e.done; _e = _d.next()) {
                var declaredDirective = _e.value;
                var declaredDirectiveMetadata = resolver.getDirectiveMetadata(declaredDirective.reference);
                if (declaredDirectiveMetadata.isComponent) {
                    var _f = parseTemplate(declaredDirectiveMetadata, module, module.transitiveModule.directives), parsedTemplate = _f.template, parsedPipes = _f.pipes;
                    compileComponent(localCtx, declaredDirectiveMetadata, parsedPipes, parsedTemplate, reflector, hostBindingParser, 1 /* BackPatch */);
                }
                else {
                    compileDirective(localCtx, declaredDirectiveMetadata, reflector, hostBindingParser, 1 /* BackPatch */);
                }
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (_e && !_e.done && (_g = _d.return)) _g.call(_d);
            }
            finally { if (e_2) throw e_2.error; }
        }
        try {
            // Back-patch all pipes declared in the module.
            for (var _h = tslib_1.__values(module.declaredPipes), _j = _h.next(); !_j.done; _j = _h.next()) {
                var pipeType = _j.value;
                var pipeMetadata = resolver.getPipeMetadata(pipeType.reference);
                if (pipeMetadata) {
                    compilePipe(localCtx, pipeMetadata, reflector, 1 /* BackPatch */);
                }
            }
        }
        catch (e_3_1) { e_3 = { error: e_3_1 }; }
        finally {
            try {
                if (_j && !_j.done && (_k = _h.return)) _k.call(_h);
            }
            finally { if (e_3) throw e_3.error; }
        }
        if (errors.length) {
            throw new Error(errors.map(function (e) { return e.toString(); }).join('\n'));
        }
    }
    outputCtx.statements.push(new o.DeclareFunctionStmt(name, [], tslib_1.__spread(imports, statements), o.INFERRED_TYPE, [o.StmtModifier.Exported]));
    var e_1, _c, e_2, _g, e_3, _k;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicjNfYmFja19wYXRjaF9jb21waWxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2NvbXBpbGVyL3NyYy9yZW5kZXIzL3IzX2JhY2tfcGF0Y2hfY29tcGlsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HOztBQUlILE9BQU8sRUFBQyw0QkFBNEIsRUFBRSx3QkFBd0IsRUFBRSxLQUFLLEVBQWMsTUFBTSxFQUFDLE1BQU0sYUFBYSxDQUFDO0FBRTlHLE9BQU8sS0FBSyxDQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFDMUMsT0FBTyxFQUFDLGFBQWEsRUFBQyxNQUFNLG1DQUFtQyxDQUFDO0FBSWhFLE9BQU8sRUFBQyxXQUFXLEVBQUMsTUFBTSxvQkFBb0IsQ0FBQztBQUMvQyxPQUFPLEVBQUMsc0JBQXNCLEVBQWEsTUFBTSxZQUFZLENBQUM7QUFDOUQsT0FBTyxFQUFDLGdCQUFnQixFQUFFLGdCQUFnQixFQUFDLE1BQU0sb0JBQW9CLENBQUM7QUFPdEU7O0dBRUc7QUFDSCxNQUFNLGlDQUNGLFNBQXdCLEVBQUUsSUFBWSxFQUFFLE1BQStCLEVBQUUsSUFBZ0IsRUFDekYsb0JBQW1FLEVBQ25FLGFBS0MsRUFDRCxTQUEwQixFQUFFLFFBQWlDO0lBQy9ELElBQU0sT0FBTyxHQUFrQixFQUFFLENBQUM7SUFDbEMsSUFBSSxVQUFVLEdBQWtCLEVBQUUsQ0FBQzs7UUFFbkMsK0JBQStCO1FBQy9CLEdBQUcsQ0FBQyxDQUF5QixJQUFBLEtBQUEsaUJBQUEsTUFBTSxDQUFDLGVBQWUsQ0FBQSxnQkFBQTtZQUE5QyxJQUFNLGNBQWMsV0FBQTtZQUN2QixJQUFNLHVCQUF1QixHQUFHLG9CQUFvQixDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUUxRSxrQ0FBa0M7WUFDbEMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxXQUFXLENBQUMs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QUFDOztBQUMxRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBJbmMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuXG5pbXBvcnQge1N0YXRpY1JlZmxlY3Rvcn0gZnJvbSAnLi4vYW90L3N0YXRpY19yZWZsZWN0b3InO1xuaW1wb3J0IHtDb21waWxlRGlyZWN0aXZlTWV0YWRhdGEsIENvbXBpbGVJZGVudGlmaWVyTWV0YWRhdGEsIENvbXBpbGVOZ01vZHVsZU1ldGFkYXRhLCBDb21waWxlUGlwZVN1bW1hcnksIENvbXBpbGVUeXBlTWV0YWRhdGF9IGZyb20gJy4uL2NvbXBpbGVfbWV0YWRhdGEnO1xuaW1wb3J0IHtERUZBVUxUX0lOVEVSUE9MQVRJT05fQ09ORklHLCBEb21FbGVtZW50U2NoZW1hUmVnaXN0cnksIExleGVyLCBQYXJzZUVycm9yLCBQYXJzZXJ9IGZyb20gJy4uL2NvbXBpbGVyJztcbmltcG9ydCB7Q29tcGlsZU1ldGFkYXRhUmVzb2x2ZXJ9IGZyb20gJy4uL21ldGFkYXRhX3Jlc29sdmVyJztcbmltcG9ydCAqIGFzIG8gZnJvbSAnLi4vb3V0cHV0L291dHB1dF9hc3QnO1xuaW1wb3J0IHtCaW5kaW5nUGFyc2VyfSBmcm9tICcuLi90ZW1wbGF0ZV9wYXJzZXIvYmluZGluZ19wYXJzZXInO1xuaW1wb3J0IHtUZW1wbGF0ZUFzdH0gZnJvbSAnLi4vdGVtcGxhdGVfcGFyc2VyL3RlbXBsYXRlX2FzdCc7XG5pbXBvcnQge091dHB1dENvbnRleHR9IGZyb20gJy4uL3V0aWwnO1xuXG5pbXBvcnQge2NvbXBpbGVQaXBlfSBmcm9tICcuL3IzX3BpcGVfY29tcGlsZXInO1xuaW1wb3J0IHtCVUlMRF9PUFRJTUlaRVJfUkVNT1ZFLCBPdXRwdXRNb2RlfSBmcm9tICcuL3IzX3R5cGVzJztcbmltcG9ydCB7Y29tcGlsZUNvbXBvbmVudCwgY29tcGlsZURpcmVjdGl2ZX0gZnJvbSAnLi9yM192aWV3X2NvbXBpbGVyJztcblxuZXhwb3J0IGNvbnN0IGVudW0gTW9kdWxlS2luZCB7XG4gIFJlbmRlcmVyMixcbiAgUmVuZGVyZXIzLFxufVxuXG4vKipcbiAqIFByb2R1Y2UgdGhlIGJhY2stcGF0Y2hpbmcgZnVuY3Rpb24gZm9yIHRoZSBnaXZlbiBtb2R1bGUgdG8gdGhlIG91dHB1dCBjb250ZXh0LlxuICovXG5leHBvcnQgZnVuY3Rpb24gY29tcGlsZU1vZHVsZUJhY2tQYXRjaChcbiAgICBvdXRwdXRDdHg6IE91dHB1dENvbnRleHQsIG5hbWU6IHN0cmluZywgbW9kdWxlOiBDb21waWxlTmdNb2R1bGVNZXRhZGF0YSwga2luZDogTW9kdWxlS2luZCxcbiAgICBiYWNrUGF0Y2hSZWZlcmVuY2VPZjogKG1vZHVsZTogQ29tcGlsZVR5cGVNZXRhZGF0YSkgPT4gby5FeHByZXNzaW9uLFxuICAgIHBhcnNlVGVtcGxhdGU6IChcbiAgICAgICAgY29tcE1ldGE6IENvbXBpbGVEaXJlY3RpdmVNZXRhZGF0YSwgbmdNb2R1bGU6IENvbXBpbGVOZ01vZHVsZU1ldGFkYXRhLFxuICAgICAgICBkaXJlY3RpdmVJZGVudGlmaWVyczogQ29tcGlsZUlkZW50aWZpZXJNZXRhZGF0YVtdKSA9PiB7XG4gICAgICB0ZW1wbGF0ZTogVGVtcGxhdGVBc3RbXSxcbiAgICAgIHBpcGVzOiBDb21waWxlUGlwZVN1bW1hcnlbXVxuICAgIH0sXG4gICAgcmVmbGVjdG9yOiBTdGF0aWNSZWZsZWN0b3IsIHJlc29sdmVyOiBDb21waWxlTWV0YWRhdGFSZXNvbHZlcikge1xuICBjb25zdCBpbXBvcnRzOiBvLlN0YXRlbWVudFtdID0gW107XG4gIGxldCBzdGF0ZW1lbnRzOiBvLlN0YXRlbWVudFtdID0gW107XG5cbiAgLy8gQ2FsbCBkZXBlbmRlbnQgYmFjayBwYXRjaGluZ1xuICBmb3IgKGNvbnN0IGltcG9ydGVkTW9kdWxlIG9mIG1vZHVsZS5pbXBvcnRlZE1vZHVsZXMpIHtcbiAgICBjb25zdCBpbXBvcnRCYWNrUGF0Y2hGdW5jdGlvbiA9IGJhY2tQYXRjaFJlZmVyZW5jZU9mKGltcG9ydGVkTW9kdWxlLnR5cGUpO1xuXG4gICAgLy8gZS5nLiAvLyBAQlVJTERfT1BUSU1JWkVSX1JFTU9WRVxuICAgIGltcG9ydHMucHVzaChuZXcgby5Db21tZW50U3RtdChCVUlMRF9PUFRJTUlaRVJfUkVNT1ZFKSk7XG5cbiAgICAvLyBlLmcuIG5nQmFja1BhdGNoX3NvbWVfb3RoZXJfbW9kdWxlX01vZHVsZSgpO1xuICAgIGltcG9ydHMucHVzaChpbXBvcnRCYWNrUGF0Y2hGdW5jdGlvbi5jYWxsRm4oW10pLnRvU3RtdCgpKTtcbiAgfVxuXG4gIC8vIFRoZSBsb2NhbCBvdXRwdXQgY29udGV4dCBhbGxvd3MgY29sbGVjdGluZyB0aGUgYmFjay1wYXRjaCBzdGF0ZW1lbnRzIHRoYXRcbiAgLy8gYXJlIGdlbmVyYXRlZCBieSB0aGUgdmFyaW91cyBjb21waWxlcnMgd2hpY2ggYWxsb3dzIHB1dHRpbmcgcGxhY2luZyB0aGVtXG4gIC8vIGludG8gdGhlIGJvZHkgb2YgYSBmdW5jdGlvbiBpbnN0ZWFkIG9mIGF0IGdsb2JhbCBzY29wZS5cbiAgY29uc3QgbG9jYWxDdHg6IE91dHB1dENvbnRleHQgPSB7XG4gICAgc3RhdGVtZW50cyxcbiAgICBjb25zdGFudFBvb2w6IG91dHB1dEN0eC5jb25zdGFudFBvb2wsXG4gICAgZ2VuRmlsZVBhdGg6IG91dHB1dEN0eC5nZW5GaWxlUGF0aCxcbiAgICBpbXBvcnRFeHByOiBvdXRwdXRDdHguaW1wb3J0RXhwclxuICB9O1xuXG4gIC8vIGUuZy4gZXhwb3J0IGZ1bmN0aW9uIG5nQmFja1BhdGNoX3NvbWVfbW9kdWxlX0xpYjFNb2R1bGUoKVxuICBpZiAoa2luZCA9PT0gTW9kdWxlS2luZC5SZW5kZXJlcjIpIHtcbiAgICAvLyBGb3IgYWxsIFJlbmRlcmVyMiBtb2R1bGVzIGdlbmVyYXRlIGJhY2stcGF0Y2hpbmcgY29kZSBmb3IgYWxsIHRoZSBjb21wb25lbnRzLCBkaXJlY3RpdmVzLFxuICAgIC8vIHBpcGVzLCBhbmQgaW5qZWN0YWJsZXMgYXMgd2VsbCBhcyB0aGUgaW5qZWN0b3IgZGVmIGZvciB0aGUgbW9kdWxlIGl0c2VsZi5cblxuICAgIGNvbnN0IGV4cHJlc3Npb25QYXJzZXIgPSBuZXcgUGFyc2VyKG5ldyBMZXhlcigpKTtcbiAgICBjb25zdCBlbGVtZW50U2NoZW1hUmVnaXN0cnkgPSBuZXcgRG9tRWxlbWVudFNjaGVtYVJlZ2lzdHJ5KCk7XG4gICAgY29uc3QgZXJyb3JzOiBQYXJzZUVycm9yW10gPSBbXTtcbiAgICBjb25zdCBob3N0QmluZGluZ1BhcnNlciA9IG5ldyBCaW5kaW5nUGFyc2VyKFxuICAgICAgICBleHByZXNzaW9uUGFyc2VyLCBERUZBVUxUX0lOVEVSUE9MQVRJT05fQ09ORklHLCBlbGVtZW50U2NoZW1hUmVnaXN0cnksIFtdLCBlcnJvcnMpO1xuXG4gICAgLy8gQmFjay1wYXRjaCBhbGwgZGVjbGFyZWQgZGlyZWN0aXZlIGFuZCBjb21wb25lbnRzXG4gICAgZm9yIChjb25zdCBkZWNsYXJlZERpcmVjdGl2ZSBvZiBtb2R1bGUuZGVjbGFyZWREaXJlY3RpdmVzKSB7XG4gICAgICBjb25zdCBkZWNsYXJlZERpcmVjdGl2ZU1ldGFkYXRhID0gcmVzb2x2ZXIuZ2V0RGlyZWN0aXZlTWV0YWRhdGEoZGVjbGFyZWREaXJlY3RpdmUucmVmZXJlbmNlKTtcbiAgICAgIGlmIChkZWNsYXJlZERpcmVjdGl2ZU1ldGFkYXRhLmlzQ29tcG9uZW50KSB7XG4gICAgICAgIGNvbnN0IHt0ZW1wbGF0ZTogcGFyc2VkVGVtcGxhdGUsIHBpcGVzOiBwYXJzZWRQaXBlc30gPVxuICAgICAgICAgICAgcGFyc2VUZW1wbGF0ZShkZWNsYXJlZERpcmVjdGl2ZU1ldGFkYXRhLCBtb2R1bGUsIG1vZHVsZS50cmFuc2l0aXZlTW9kdWxlLmRpcmVjdGl2ZXMpO1xuICAgICAgICBjb21waWxlQ29tcG9uZW50KFxuICAgICAgICAgICAgbG9jYWxDdHgsIGRlY2xhcmVkRGlyZWN0aXZlTWV0YWRhdGEsIHBhcnNlZFBpcGVzLCBwYXJzZWRUZW1wbGF0ZSwgcmVmbGVjdG9yLFxuICAgICAgICAgICAgaG9zdEJpbmRpbmdQYXJzZXIsIE91dHB1dE1vZGUuQmFja1BhdGNoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbXBpbGVEaXJlY3RpdmUoXG4gICAgICAgICAgICBsb2NhbEN0eCwgZGVjbGFyZWREaXJlY3RpdmVNZXRhZGF0YSwgcmVmbGVjdG9yLCBob3N0QmluZGluZ1BhcnNlcixcbiAgICAgICAgICAgIE91dHB1dE1vZGUuQmFja1BhdGNoKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBCYWNrLXBhdGNoIGFsbCBwaXBlcyBkZWNsYXJlZCBpbiB0aGUgbW9kdWxlLlxuICAgIGZvciAoY29uc3QgcGlwZVR5cGUgb2YgbW9kdWxlLmRlY2xhcmVkUGlwZXMpIHtcbiAgICAgIGNvbnN0IHBpcGVNZXRhZGF0YSA9IHJlc29sdmVyLmdldFBpcGVNZXRhZGF0YShwaXBlVHlwZS5yZWZlcmVuY2UpO1xuICAgICAgaWYgKHBpcGVNZXRhZGF0YSkge1xuICAgICAgICBjb21waWxlUGlwZShsb2NhbEN0eCwgcGlwZU1ldGFkYXRhLCByZWZsZWN0b3IsIE91dHB1dE1vZGUuQmFja1BhdGNoKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoZXJyb3JzLmxlbmd0aCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9ycy5tYXAoZSA9PiBlLnRvU3RyaW5nKCkpLmpvaW4oJ1xcbicpKTtcbiAgICB9XG4gIH1cblxuICBvdXRwdXRDdHguc3RhdGVtZW50cy5wdXNoKG5ldyBvLkRlY2xhcmVGdW5jdGlvblN0bXQoXG4gICAgICBuYW1lLCBbXSwgWy4uLmltcG9ydHMsIC4uLnN0YXRlbWVudHNdLCBvLklORkVSUkVEX1RZUEUsIFtvLlN0bXRNb2RpZmllci5FeHBvcnRlZF0pKTtcbn1cbiJdfQ==